<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ZPROVEART</title>
<link rel="stylesheet" href="{{ url_for('static', path='css/zproveart.css') }}">
</head>

<body>

<h1>ZPROVEART</h1>

<form class="filters block" method="get" action="/zproveart">

    <!-- IZQUIERDA: familias -->
    <div class="fam-list">
    {% for f in families %}
        <label class="fam-item">
            <input type="checkbox" name="family" value="{{ f.COD_FAM_0|string }}"
                {% if (f.COD_FAM_0|string) in family_list %}checked{% endif %}>
            <span class="fam-text">{{ f.COD_FAM_0 }} - {{ f.DES_FAM_0 }}</span>
        </label>
    {% endfor %}
    </div>

    <!-- DERECHA: filtros agrupados en columna -->
    <div class="filters-right">

        <!-- Fecha -->
        <div class="filter-group">
            <div class="filter-title">Fecha</div>
            <div class="filter-row">
            <label class="muted">Desde</label>
            <input type="date" name="from" value="{{ date_from }}">
            <label class="muted">Hasta</label>
            <input type="date" name="to" value="{{ date_to }}">
            </div>
        </div>

        <!-- Proveedor -->
        <div class="filter-group">
            <div class="filter-title">Proveedor</div>
            <div class="filter-row">
            <label>Desde</label>
            <input type="text" name="supp_from" inputmode="numeric" pattern="\d{5}" maxlength="5"
                    value="{{ supp_from or '' }}">
            <label>Hasta</label>
            <input type="text" name="supp_to" inputmode="numeric" pattern="\d{5}" maxlength="5"
                    value="{{ supp_to or '' }}">
            </div>
        </div>

        <!-- Comprador -->
        <div class="filter-group">
            <div class="filter-title">Comprador</div>
            <div class="filter-row">
            <label>Desde</label>
            <input type="text" name="comp_from" maxlength="4" value="{{ comp_from or '' }}">
            <label>Hasta</label>
            <input type="text" name="comp_to" maxlength="4" value="{{ comp_to or '' }}">
            </div>
        </div>

        <!-- Artículo -->
        <div class="filter-group">
            <div class="filter-title">Artículo</div>
            <div class="filter-row">
            <label>Desde</label>
            <input type="text" name="art_from" maxlength="13" pattern="\d{13}" value="{{ art_from or '' }}">
            <label>Hasta</label>
            <input type="text" name="art_to" maxlength="13" pattern="\d{13}" value="{{ art_to or '' }}">
            </div>
        </div>

        <!-- Botón -->
        <div class="filters-actions">
            <input type="hidden" name="page" value="1">
            <button type="submit">Aplicar Filtros</button>
        </div>

        </div>
</form>

<div class="grid">
{% for p in products %}
<div class="card">

    <!-- CABECERA (Articulo + Proveedor + Familia) -->
    <div class="block card-head">
        <div class="header header-row">
            <div class="head-item h1">
                ARTÍCULO: {{ p.ITMREF_0 }} - {{ p.ITMDES_0 }}
            </div>
            <div class="head-item h2">
                Proveedor: {{ p.BPSNUM_0 }} - {{ p.BPSNAM_0 }}
            </div>
            <div class="head-item h2">
                Familia: {{ p.COD_FAM_0 }} - {{ p.DES_FAM_0 }}
            </div>
        </div>
    </div>

    <!-- CUERPO (Foto | ZV | Tabla) -->
    <div class="block card-body">
        <div class="body-row">

            <!-- Foto -->
            <div class="thumb">
            {% if p.URL_0 %}
                <img
                src="{{ p.URL_0 }}"
                alt="Imagen producto"
                onerror="
                    if (!this.dataset.ch) {
                    this.dataset.ch = '1';
                    this.src = this.src.replace(/\.jpg$/i, '_ch.jpg');
                    } else {
                    this.style.display = 'none';
                    }
                ">
            {% else %}
                <span class="muted">Sin imagen</span>
            {% endif %}
            </div>

            <!-- ZV -->
            <div class="block body-zv">
                <div class="kv-grid">
                    <div class="kv"><div class="k">F. últ. compra</div><div class="v">{{ p.FUC_0_FMT }}</div></div>
                    <div class="kv"><div class="k">UQTY</div><div class="v">{{ p.UQTY_0 }}</div></div>
                    <div class="kv"><div class="k">FOB</div><div class="v">{{ p.FOB_0_FMT }}</div></div>

                    <div class="kv"><div class="k">P. Unidad</div><div class="v">{{ p.PUE_0_FMT }}</div></div>
                    <div class="kv"><div class="k">PVP</div><div class="v">{{ p.PVPT4_0_FMT }}</div></div>
                    <div class="kv"><div class="k">DTO</div><div class="v">{{ p.DTO_0_FMT }}</div></div>

                    <div class="kv"><div class="k">DIF</div><div class="v">{{ p.DIF_0_FMT }}</div></div>
                    <div class="kv"><div class="k">Arancel</div><div class="v">{{ p.ARANCEL_0_FMT }}</div></div>
                </div>
            </div>

            <!-- ZV2 -->
            <div class="block body-zv body-zv2">
                <div class="kv-grid">
                    <div class="kv"><div class="k">EXIST. ACTUALES</div><div class="v">{{ p.EX_ACT_0_FMT }}</div></div>
                    <div class="kv"><div class="k">EXIST. DISPONIBLES</div><div class="v">{{ p.EX_DISP_0_FMT }}</div></div>
                    <div class="kv"><div class="k">EXIST. EN SC</div><div class="v">{{ p.QTY_PEND_SC_0_FMT }}</div></div>
                    <div class="kv"><div class="k">EXIST. PREV. ENTRAR.</div><div class="v">{{ p.EX_PREV_0_FMT }}</div></div>
                    <div class="kv kv-multi">
                        <div class="k">F. PREVISTA LLEGADA</div>
                        <div class="v">
                            {% if p.eta and p.eta|length > 0 %}
                                {% for r in p.eta %}
                                    <div>{{ r.fecha }} - {{ r.qty }} - {{ r.vcr }}</div>
                                {% endfor %}
                                {% if p.eta_extra and p.eta_extra > 0 %}
                                    <div class="muted">+{{ p.eta_extra }} más…</div>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ZV3 LOGÍSTICA -->
        <div class="block body-zv body-zv3">
            <div class="kv-grid">
                <div class="kv"><div class="k">Cod. art. prov.</div><div class="v">{{ p.COD_ART_PRO_0_FMT }}</div></div>
                <div class="kv"><div class="k">Med. pieza</div><div class="v">{{ p.MED_PZ_0_FMT }}</div></div>
                <div class="kv"><div class="k">Med. caja</div><div class="v">{{ p.MED_CJ_0_FMT }}</div></div>
                <div class="kv"><div class="k">Cubicaje</div><div class="v">{{ p.CUBIC_0_FMT }}</div></div>

                <div class="kv"><div class="k">Unid./Caja</div><div class="v">{{ p.UNXCAJ_0_FMT }}</div></div>
                <div class="kv"><div class="k">Unid./Palet</div><div class="v">{{ p.UNXPAL_0_FMT }}</div></div>
                <div class="kv"><div class="k">Unid./Paquete</div><div class="v">{{ p.UNXPAQ_0_FMT }}</div></div>

                <div class="kv"><div class="k">Puerto</div><div class="v">{{ p.ZPUERTO_0_FMT }}</div></div>
                <div class="kv"><div class="k">Slim</div><div class="v">{{ p.ZSLIM_0_FMT }}</div></div>
                <div class="kv"><div class="k">CMC</div><div class="v">{{ p.CMC_0_FMT }}</div></div>

                <div class="kv"><div class="k">Venta NTV</div><div class="v">{{ p.ZVERNTV_0_FMT }}</div></div>
                <div class="kv"><div class="k">Venta sin stock</div><div class="v">{{ p.ZVTASINSTOCK_0_FMT }}</div></div>
            </div>
        </div>

            <!-- Tabla -->
            <div class="block body-table">
                <div class="m12-title">Ventas / Compras últimos 12 meses</div>
                <table class="m12">
                    <tr>
                        <th>Mes</th>
                        <th>Ventas</th>
                        <th>Compras</th>
                    </tr>
                    {% for r in p.m12 %}
                    <tr>
                        <td>{{ r.label }}</td>
                        <td>{{ r.ventas }}</td>
                        <td>{{ r.compras }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

        </div>
    </div>

    <!-- PIE (Checkbox + comentario + botón) -->
    <div class="block card-foot">
        <form class="actions js-send" method="post" action="/zproveart/submit">
            <input type="hidden" name="itmref" value="{{ p.ITMREF_0 }}">
            <label><input type="checkbox" name="selected" value="1"> Sel</label>
            <input type="text" name="comment" placeholder="Comentario...">
            <button type="submit">Enviar</button>
        </form>
    </div>

</div>
{% endfor %}
</div>

<div class="pager">
    <a class="{% if page <= 1 %}disabled{% endif %}"
        href="/zproveart?page={{ page - 1 }}&page_size={{ page_size }}
        {%- for fc in family_list -%}&family={{ fc|urlencode }}{%- endfor -%}
        {%- if date_from -%}&from={{ date_from }}{%- endif -%}
        {%- if date_to -%}&to={{ date_to }}{%- endif -%}
        {%- if supp_from -%}&supp_from={{ supp_from }}{%- endif -%}
        {%- if supp_to -%}&supp_to={{ supp_to }}{%- endif -%}
        {%- if comp_from -%}&comp_from={{ comp_from }}{%- endif -%}
        {%- if comp_to -%}&comp_to={{ comp_to }}{%- endif -%}
        {%- if art_from -%}&art_from={{ art_from }}{%- endif -%}
        {%- if art_to -%}&art_to={{ art_to }}{%- endif -%}
        ">⬅ Prev</a>

    <span class="muted">Página {{ page }} / {{ total_pages }}</span>

    <a class="{% if page >= total_pages %}disabled{% endif %}"
        href="/zproveart?page={{ page + 1 }}&page_size={{ page_size }}
        {%- for fc in family_list -%}&family={{ fc|urlencode }}{%- endfor -%}
        {%- if date_from -%}&from={{ date_from }}{%- endif -%}
        {%- if date_to -%}&to={{ date_to }}{%- endif -%}
        {%- if supp_from -%}&supp_from={{ supp_from }}{%- endif -%}
        {%- if supp_to -%}&supp_to={{ supp_to }}{%- endif -%}
        {%- if comp_from -%}&comp_from={{ comp_from }}{%- endif -%}
        {%- if comp_to -%}&comp_to={{ comp_to }}{%- endif -%}
        {%- if art_from -%}&art_from={{ art_from }}{%- endif -%}
        {%- if art_to -%}&art_to={{ art_to }}{%- endif -%}
        ">Next ➡</a>

</div>
<script src="{{ url_for('static', path='js/zproveart.js') }}"></script>
</body>
</html>
